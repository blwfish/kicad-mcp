name: Documentation freshness check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need parent commit for diff

      - name: Check if tool files changed without CLAUDE.md update
        run: |
          # Get changed files vs parent commit
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

          # Check if any tool-related files changed
          TOOL_CHANGES=$(echo "$CHANGED" | grep -E '^src/kicad_mcp/(tools/|server\.py)' || true)

          if [ -n "$TOOL_CHANGES" ]; then
            echo "Tool files changed:"
            echo "$TOOL_CHANGES"

            # Check if CLAUDE.md was also updated
            CLAUDE_CHANGED=$(echo "$CHANGED" | grep '^CLAUDE.md$' || true)
            README_CHANGED=$(echo "$CHANGED" | grep '^README.md$' || true)

            if [ -z "$CLAUDE_CHANGED" ] && [ -z "$README_CHANGED" ]; then
              echo ""
              echo "::warning::Tool files changed but neither CLAUDE.md nor README.md were updated. If you added, removed, or renamed tools, please update the docs."
            fi
          else
            echo "No tool file changes detected."
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -e .

      - name: Verify tool count consistency
        run: |
          # Get actual tool count from server
          ACTUAL=$(python -c "
          from kicad_mcp.server import create_server
          import asyncio
          s = create_server()
          tools = asyncio.run(s.list_tools())
          print(len(tools))
          ")
          echo "Server reports $ACTUAL tools"

          # Check test_server.py
          TEST_COUNT=$(grep -oP 'Expected \K\d+' tests/test_server.py | head -1)
          echo "test_server.py expects $TEST_COUNT tools"

          # Check README.md
          README_COUNT=$(grep -oP '(\d+) tools for AI' README.md | grep -oP '^\d+' | head -1)
          echo "README.md says $README_COUNT tools"

          # Check CLAUDE.md
          CLAUDE_COUNT=$(grep -oP '(\d+) MCP tools' CLAUDE.md | grep -oP '^\d+' | head -1)
          echo "CLAUDE.md says $CLAUDE_COUNT tools"

          # Compare
          MISMATCH=0
          if [ "$ACTUAL" != "$TEST_COUNT" ]; then
            echo "::error::Tool count mismatch: server has $ACTUAL but test_server.py expects $TEST_COUNT"
            MISMATCH=1
          fi
          if [ "$ACTUAL" != "$README_COUNT" ]; then
            echo "::error::Tool count mismatch: server has $ACTUAL but README.md says $README_COUNT"
            MISMATCH=1
          fi
          if [ "$ACTUAL" != "$CLAUDE_COUNT" ]; then
            echo "::error::Tool count mismatch: server has $ACTUAL but CLAUDE.md says $CLAUDE_COUNT"
            MISMATCH=1
          fi

          if [ "$MISMATCH" = "1" ]; then
            exit 1
          else
            echo "All tool counts match: $ACTUAL"
          fi
